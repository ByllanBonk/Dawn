{% comment %}
  GK Bandsintown (Page)
  Live Bandsintown events widget — dark/orange site aesthetic.
  Intended for the full Dates page. Shows more events by default.

  MERCHANT: to change how many events show on load, go to
  Theme Editor > click this section > "Events shown on load" (under Display settings).
  To change how many are revealed per click, adjust "Events revealed per click".
{% endcomment %}

{%- liquid
  assign bit_artist          = section.settings.artist_name
  assign bit_initial_visible = section.settings.initial_visible_count
  assign bit_reveal_step     = section.settings.reveal_step
  assign bit_more_label      = section.settings.show_more_label
  assign bit_uid             = section.id | prepend: 'gkbit-page-'
-%}

<style>
/* =================================================================
   GK Bandsintown Page — layout/structure only
   BIT widget renders with its own native styling
   ================================================================= */

.gk-bit-page {
  box-sizing: border-box;
  width: 100%;
  background-color: {{ section.settings.bg_color }};
  padding-top: {{ section.settings.padding_top }}px;
  padding-bottom: {{ section.settings.padding_bottom }}px;
}
.gk-bit-page__inner {
  max-width: 900px;
  margin: 0 auto;
  padding: 0 20px;
  box-sizing: border-box;
}
.gk-bit-page__eyebrow {
  color: #ff6a00;
  font-size: 0.72em;
  font-weight: 700;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  margin: 0 0 8px;
}
.gk-bit-page__heading {
  color: #ffffff;
  font-size: clamp(1.8em, 5vw, 3em);
  font-weight: 800;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  margin: 0 0 8px;
  line-height: 1.1;
}
.gk-bit-page__subtext {
  color: rgba(255,255,255,0.5);
  font-size: 0.9em;
  margin: 0 0 32px;
}
.gk-bit-page__embed {
  width: 100%;
}

/* ---- Hide BIT internal header / artist block ---- */
.gk-bit-page .bit-top-track-header,
.gk-bit-page .bit-header,
.gk-bit-page .bit-header-future,
.gk-bit-page .bit-header-past,
.gk-bit-page [class*="bit-top-track"],
.gk-bit-page [class*="bit-header"],
.gk-bit-page .bit-powered-by,
.gk-bit-page .bit-footer,
.gk-bit-page .bit-social-share,
.gk-bit-page .bit-share-button {
  display: none !important;
}

/* ---- Hide RSVP everywhere ---- */
.gk-bit-page .bit-rsvp-pst,
.gk-bit-page .bit-rsvp-container,
.gk-bit-page .bit-not-attending-container,
.gk-bit-page .bit-notgoing-btn,
.gk-bit-page [class*="rsvp"],
.gk-bit-page a[data-bit-action="rsvp"] {
  display: none !important;
}

/* ---- Show-more button (injected by JS) ---- */
.gk-bit-page .gk-bit-more-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  color: #ff6a00;
  border: 1px solid rgba(255,106,0,0.5);
  padding: 10px 28px;
  font-size: 0.78em;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
  font-family: inherit;
  transition: background 150ms ease, border-color 150ms ease;
}
.gk-bit-page .gk-bit-more-btn:hover {
  background: rgba(255,106,0,0.12);
  border-color: #ff6a00;
}

/* ---- Fallback message ---- */
.gk-bit-page .gk-bit-fallback {
  display: none;
  color: rgba(255,255,255,0.4);
  font-size: 0.9em;
  padding: 24px 0;
  text-align: center;
}

/* ---- Editor placeholder ---- */
.gk-bit-page .gk-bit-editor-notice {
  background: rgba(255,106,0,0.08);
  border: 1px dashed rgba(255,106,0,0.35);
  color: rgba(255,255,255,0.5);
  font-size: 0.85em;
  padding: 20px 24px;
  text-align: center;
}
</style>

<section class="gk-bit-page" data-section-id="{{ section.id }}">
  <div class="gk-bit-page__inner">

    {%- if section.settings.eyebrow != blank -%}
      <div class="gk-bit-page__eyebrow">{{ section.settings.eyebrow }}</div>
    {%- endif -%}
    {%- if section.settings.heading != blank -%}
      <h2 class="gk-bit-page__heading">{{ section.settings.heading }}</h2>
    {%- endif -%}
    {%- if section.settings.subtext != blank -%}
      <p class="gk-bit-page__subtext">{{ section.settings.subtext }}</p>
    {%- endif -%}

    <div id="{{ bit_uid }}" class="gk-bit-page__embed">
      {%- if request.design_mode -%}
        <div class="gk-bit-editor-notice">
          Bandsintown events load on the live site. Save and preview to see them.
        </div>
      {%- else -%}
        {%- render 'gk-bandsintown-embed', bit_artist: bit_artist -%}
        <div class="gk-bit-fallback">Check back soon for upcoming dates.</div>
      {%- endif -%}
    </div>

  </div>
</section>

<script>
(function () {
  /* MERCHANT: change visible count in Theme Editor > this section > "Events shown on load"    */
  /* MERCHANT: change reveal step in Theme Editor > this section > "Events revealed per click" */
  var WRAP_ID   = {{ bit_uid | json }};
  var INIT      = {{ bit_initial_visible | plus: 0 }};
  var STEP      = {{ bit_reveal_step | plus: 0 }};
  var BTN_LABEL = {{ bit_more_label | default: 'SHOW MORE DATES' | json }};

  var wrap = document.getElementById(WRAP_ID);
  if (!wrap || wrap.dataset.bitInit) return;

  var applied     = false;
  var moreBtnWrap = null;

  /* Selectors tried in priority order to find event rows */
  var SEL = [
    '.bit-event',
    '.bit-event-list-item',
    'li[class*="bit-event"]',
    '[class*="bit-event"]'
  ];

  function findEvents() {
    for (var i = 0; i < SEL.length; i++) {
      var els = wrap.querySelectorAll(SEL[i]);
      if (els.length) return [].slice.call(els);
    }
    return [];
  }

  function ensureMoreBtn() {
    if (moreBtnWrap) return moreBtnWrap;
    moreBtnWrap = document.createElement('div');
    moreBtnWrap.style.cssText = 'margin-top:20px;text-align:center';
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'gk-bit-more-btn';
    btn.textContent = BTN_LABEL;
    btn.addEventListener('click', function () {
      var hidden = findEvents().filter(function (el) {
        return el.style.display === 'none';
      });
      hidden.slice(0, STEP).forEach(function (el) { el.style.display = ''; });
      syncBtn();
    });
    moreBtnWrap.appendChild(btn);
    wrap.appendChild(moreBtnWrap);
    return moreBtnWrap;
  }

  function syncBtn() {
    if (!moreBtnWrap) return;
    var anyHidden = findEvents().some(function (el) {
      return el.style.display === 'none';
    });
    moreBtnWrap.style.display = anyHidden ? '' : 'none';
  }

  function setup() {
    var events = findEvents();
    if (!events.length) return false;
    if (applied) { syncBtn(); return true; }

    applied = true;
    wrap.dataset.bitInit = '1';

    events.forEach(function (el, i) {
      el.style.display = i < INIT ? '' : 'none';
    });

    if (events.length > INIT) {
      ensureMoreBtn();
      syncBtn();
    }
    return true;
  }

  /* Run immediately if widget already rendered */
  if (setup()) return;

  /* MutationObserver with 200ms debounce (waits for full render burst) */
  var debounce;
  var obs = new MutationObserver(function () {
    clearTimeout(debounce);
    debounce = setTimeout(function () {
      if (setup()) {
        clearInterval(retryTimer);
        obs.disconnect();
      }
    }, 200);
  });
  obs.observe(wrap, { childList: true, subtree: true });

  /* setInterval retry every 250ms for up to 5 seconds */
  var elapsed = 0;
  var retryTimer = setInterval(function () {
    elapsed += 250;
    if (setup() || elapsed >= 5000) {
      clearInterval(retryTimer);
      obs.disconnect();
      if (!applied) {
        var fb = wrap.querySelector('.gk-bit-fallback');
        if (fb) fb.style.display = '';
      }
    }
  }, 250);
})();
</script>

{% schema %}
{
  "name": "GK Bandsintown (Page)",
  "settings": [
    {
      "type": "header",
      "content": "Header text"
    },
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow",
      "default": "Tour Dates"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "TOUR DATES"
    },
    {
      "type": "text",
      "id": "subtext",
      "label": "Subtext",
      "default": "See upcoming dates below."
    },
    {
      "type": "header",
      "content": "Bandsintown"
    },
    {
      "type": "text",
      "id": "artist_name",
      "label": "Artist name",
      "info": "Must match exactly as listed on Bandsintown, e.g. Greg Koch",
      "default": "Greg Koch"
    },
    {
      "type": "header",
      "content": "Display settings"
    },
    {
      "type": "range",
      "id": "initial_visible_count",
      "label": "Events shown on load",
      "min": 1,
      "max": 30,
      "step": 1,
      "default": 10
    },
    {
      "type": "range",
      "id": "reveal_step",
      "label": "Events revealed per click",
      "min": 1,
      "max": 30,
      "step": 1,
      "default": 10
    },
    {
      "type": "text",
      "id": "show_more_label",
      "label": "Show more button label",
      "default": "SHOW MORE DATES"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#0D0D0D"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 64
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 64
    }
  ],
  "presets": [
    {
      "name": "GK Bandsintown (Page)"
    }
  ]
}
{% endschema %}
