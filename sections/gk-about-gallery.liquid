{%- comment -%}
  GK About Gallery Section
  - Mimics old site: heading + big main image + credit + thumbnail row
  - Thumbnails open a fullscreen modal (image lightbox)
  - Premium motion + subtle lift (matches GK rules)
  - Self-contained CSS + JS, scoped to section.id
{%- endcomment -%}

<section
  id="GK-AboutGallery-{{ section.id }}"
  class="gk-aboutGallery"
  data-gk-anim="{{ section.settings.enable_animation | json }}"
>
  <div class="page-width gk-aboutGallery__inner">

    {%- if section.settings.heading != blank -%}
      <h2 class="gk-aboutGallery__heading">{{ section.settings.heading }}</h2>
    {%- endif -%}

    {%- if section.settings.main_image != blank -%}
      <figure class="gk-aboutGallery__heroFigure">
        <a
          class="gk-aboutGallery__heroLink"
          href="#"
          data-gk-open
          data-gk-src="{{ section.settings.main_image | image_url: width: 2800 }}"
          data-gk-alt="{{ section.settings.main_image.alt | escape }}"
        >
          <div class="gk-aboutGallery__heroMedia">
            {%- liquid
              assign img = section.settings.main_image
              assign img_h = img.width | divided_by: img.aspect_ratio
            -%}
            {{
              img
              | image_url: width: 2400
              | image_tag:
                width: img.width,
                height: img_h,
                loading: 'lazy',
                widths: '700, 1000, 1400, 1800, 2200, 2400',
                sizes: '(min-width: 990px) 1100px, (min-width: 750px) 92vw, 94vw',
                class: 'gk-aboutGallery__heroImg'
            }}
          </div>
        </a>

        {%- if section.settings.main_credit != blank -%}
          <figcaption class="gk-aboutGallery__credit">
            {{ section.settings.main_credit }}
          </figcaption>
        {%- endif -%}
      </figure>
    {%- endif -%}

    {%- if section.settings.body != blank -%}
      <div class="gk-aboutGallery__rte rte">
        {{ section.settings.body }}
      </div>
    {%- endif -%}

    {%- if section.blocks.size > 0 -%}
      <div class="gk-aboutGallery__thumbGrid" role="list">
        {%- for block in section.blocks -%}
          {%- if block.type == 'image' and block.settings.image != blank -%}
            {%- liquid
              assign t = block.settings.image
              assign t_h = t.width | divided_by: t.aspect_ratio
              assign full = t | image_url: width: 2800
              assign alt = t.alt
              if block.settings.alt != blank
                assign alt = block.settings.alt
              endif
            -%}

            <button
              type="button"
              class="gk-aboutGallery__thumb"
              role="listitem"
              data-gk-open
              data-gk-src="{{ full }}"
              data-gk-alt="{{ alt | escape }}"
              aria-label="Open image"
              {{ block.shopify_attributes }}
            >
              {{
                t
                | image_url: width: 900
                | image_tag:
                  width: t.width,
                  height: t_h,
                  loading: 'lazy',
                  widths: '300, 450, 600, 750, 900',
                  sizes: '(min-width: 990px) 260px, (min-width: 750px) 22vw, 42vw',
                  class: 'gk-aboutGallery__thumbImg'
              }}
            </button>
          {%- endif -%}
        {%- endfor -%}
      </div>
    {%- endif -%}
  </div>

  {%- comment -%} Modal (scoped) {%- endcomment -%}
  <div class="gk-aboutGallery__modal" hidden aria-hidden="true">
    <div class="gk-aboutGallery__backdrop" data-gk-close></div>

    <div
      class="gk-aboutGallery__dialog"
      role="dialog"
      aria-modal="true"
      aria-label="Image preview"
      tabindex="-1"
    >
      <button type="button" class="gk-aboutGallery__close" data-gk-close aria-label="Close">
        ×
      </button>

      <div class="gk-aboutGallery__modalMedia">
        <img class="gk-aboutGallery__modalImg" alt="" loading="eager" />
      </div>
    </div>
  </div>

  <style>
    /* ============================
      GK About Gallery (scoped)
      ============================ */
    #GK-AboutGallery-{{ section.id }}.gk-aboutGallery {
      --accent: {{ section.settings.accent | default: '#E8690A' }};
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.66);
      --line: rgba(255,255,255,0.10);
      --card: rgba(255,255,255,0.06);
      --shadow: 0 14px 44px rgba(0,0,0,0.35);

      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__inner {
      max-width: 1100px;
      margin: 0 auto;
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__heading {
      margin: 0 0 18px 0;
      font-weight: 800;
      line-height: 1.05;
      letter-spacing: 0.01em;
      /* match the big, confident Dawn/GK headline feel */
      font-size: clamp(34px, 4.5vw, 56px);
    }

    /* Hero image */
    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__heroFigure { margin: 0; }
    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__heroLink { display: block; text-decoration: none; color: inherit; }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__heroMedia {
      position: relative;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__heroImg {
      display: block;
      width: 100%;
      height: auto;
      transform: translateZ(0);
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__credit {
      margin-top: 10px;
      font-style: italic;
      color: var(--muted);
      text-align: right;
    }

    /* Body copy */
    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__rte {
      margin-top: 18px;
      color: var(--text);
    }

    /* Thumbnails */
    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__thumbGrid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
    }

    @media (max-width: 749px) {
      #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__thumbGrid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__thumb {
      appearance: none;
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: 12px;
      padding: 0;
      cursor: pointer;
      overflow: hidden;
      box-shadow: 0 10px 28px rgba(0,0,0,0.28);
      transform: translateZ(0);
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__thumbImg {
      display: block;
      width: 100%;
      height: auto;
    }

    /* Hover rules (subtle 1px lift, orange tint, crisp) */
    @media (hover: hover) {
      #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__thumb,
      #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__heroMedia {
        transition: transform 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
      }

      #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__thumb:hover {
        transform: translateY(-1px);
        border-color: rgba(232,105,10,0.35);
        box-shadow: 0 16px 40px rgba(0,0,0,0.38);
      }

      #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__heroMedia:hover {
        transform: translateY(-1px);
        border-color: rgba(232,105,10,0.35);
        box-shadow: 0 18px 54px rgba(0,0,0,0.45);
      }
    }

    /* ============================
      Motion: Depth Slide + Text Fly
      ============================ */
    #GK-AboutGallery-{{ section.id }}[data-gk-anim="true"] .gk-aboutGallery__heroMedia,
    #GK-AboutGallery-{{ section.id }}[data-gk-anim="true"] .gk-aboutGallery__heading,
    #GK-AboutGallery-{{ section.id }}[data-gk-anim="true"] .gk-aboutGallery__rte,
    #GK-AboutGallery-{{ section.id }}[data-gk-anim="true"] .gk-aboutGallery__thumbGrid {
      opacity: 0;
      transform: translateY(18px);
      will-change: transform, opacity;
    }

    /* More pronounced for main image (still tasteful) */
    #GK-AboutGallery-{{ section.id }}[data-gk-anim="true"] .gk-aboutGallery__heroMedia {
      transform: translateY(14px) scale(1.03);
    }

    #GK-AboutGallery-{{ section.id }}.gk-in .gk-aboutGallery__heroMedia {
      opacity: 1;
      transform: translateY(0) scale(1);
      transition: opacity 650ms cubic-bezier(.16,.84,.44,1),
                  transform 900ms cubic-bezier(.16,.84,.44,1);
    }

    #GK-AboutGallery-{{ section.id }}.gk-in .gk-aboutGallery__heading {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 650ms cubic-bezier(.16,.84,.44,1) 120ms,
                  transform 650ms cubic-bezier(.16,.84,.44,1) 120ms;
    }

    #GK-AboutGallery-{{ section.id }}.gk-in .gk-aboutGallery__rte {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 650ms cubic-bezier(.16,.84,.44,1) 200ms,
                  transform 650ms cubic-bezier(.16,.84,.44,1) 200ms;
    }

    #GK-AboutGallery-{{ section.id }}.gk-in .gk-aboutGallery__thumbGrid {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 650ms cubic-bezier(.16,.84,.44,1) 260ms,
                  transform 650ms cubic-bezier(.16,.84,.44,1) 260ms;
    }

    @media (prefers-reduced-motion: reduce) {
      #GK-AboutGallery-{{ section.id }}[data-gk-anim="true"] .gk-aboutGallery__heroMedia,
      #GK-AboutGallery-{{ section.id }}[data-gk-anim="true"] .gk-aboutGallery__heading,
      #GK-AboutGallery-{{ section.id }}[data-gk-anim="true"] .gk-aboutGallery__rte,
      #GK-AboutGallery-{{ section.id }}[data-gk-anim="true"] .gk-aboutGallery__thumbGrid {
        opacity: 1 !important;
        transform: none !important;
        transition: none !important;
      }
    }

    /* ============================
      Modal (fullscreen)
      ============================ */
    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__modal[hidden] { display: none !important; }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__modal {
      position: fixed;
      inset: 0;
      z-index: 9999;
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__dialog {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 22px;
      outline: none;
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__modalMedia {
      position: relative;
      width: min(1100px, 96vw);
      max-height: 92vh;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      box-shadow: 0 22px 80px rgba(0,0,0,0.55);
      overflow: hidden;
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__modalImg {
      display: block;
      width: 100%;
      height: auto;
      max-height: 92vh;
      object-fit: contain;
      background: rgba(0,0,0,0.15);
    }

    #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__close {
      position: absolute;
      top: 16px;
      right: 18px;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.30);
      color: rgba(255,255,255,0.92);
      font-size: 26px;
      line-height: 1;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: transform 160ms ease, border-color 160ms ease, background 160ms ease;
    }

    @media (hover:hover) {
      #GK-AboutGallery-{{ section.id }} .gk-aboutGallery__close:hover {
        transform: translateY(-1px);
        border-color: rgba(232,105,10,0.35);
        background: rgba(0,0,0,0.45);
      }
    }
  </style>

  <script>
    (function() {
      var root = document.getElementById('GK-AboutGallery-{{ section.id }}');
      if (!root) return;

      // Animation reveal
      var animEnabled = root.getAttribute('data-gk-anim') === 'true';
      if (animEnabled && !(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches)) {
        var revealed = false;
        var reveal = function() {
          if (revealed) return;
          revealed = true;
          root.classList.add('gk-in');
        };
        if ('IntersectionObserver' in window) {
          var io = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) { reveal(); io.disconnect(); }
            });
          }, { threshold: 0.22 });
          io.observe(root);
        } else {
          requestAnimationFrame(reveal);
        }
      } else {
        root.classList.add('gk-in');
      }

      // Modal lightbox
      var modal = root.querySelector('.gk-aboutGallery__modal');
      var modalImg = root.querySelector('.gk-aboutGallery__modalImg');
      var dialog = root.querySelector('.gk-aboutGallery__dialog');

      if (!modal || !modalImg || !dialog) return;

      var lastActive = null;

      function openModal(src, alt) {
        lastActive = document.activeElement;

        modal.hidden = false;
        modal.setAttribute('aria-hidden', 'false');
        modalImg.src = src;
        modalImg.alt = alt || '';

        // prevent background scroll
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';

        // focus dialog for ESC handling
        dialog.focus();
      }

      function closeModal() {
        modal.hidden = true;
        modal.setAttribute('aria-hidden', 'true');

        modalImg.removeAttribute('src');
        modalImg.alt = '';

        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';

        if (lastActive && lastActive.focus) lastActive.focus();
      }

      root.addEventListener('click', function(e) {
        var opener = e.target.closest('[data-gk-open]');
        if (opener) {
          e.preventDefault();
          var src = opener.getAttribute('data-gk-src');
          var alt = opener.getAttribute('data-gk-alt') || '';
          if (src) openModal(src, alt);
          return;
        }

        if (e.target.closest('[data-gk-close]')) {
          e.preventDefault();
          closeModal();
        }
      });

      document.addEventListener('keydown', function(e) {
        if (modal.hidden) return;
        if (e.key === 'Escape') {
          e.preventDefault();
          closeModal();
        }
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "GK About Gallery",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_animation",
      "default": true,
      "label": "Enable fly-in animation"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "About the Koch Marshall Trio"
    },
    {
      "type": "image_picker",
      "id": "main_image",
      "label": "Main image"
    },
    {
      "type": "text",
      "id": "main_credit",
      "label": "Main photo credit (optional)",
      "default": "above photo credit: ©2025CJFoeckler"
    },
    {
      "type": "richtext",
      "id": "body",
      "label": "Body text",
      "default": "<p>Add your updated copy here. This is editable in the theme editor.</p>"
    },
    {
      "type": "color",
      "id": "accent",
      "label": "Accent color",
      "default": "#E8690A"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 140,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 44
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 140,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 52
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Gallery image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "alt",
          "label": "Alt text override (optional)",
          "default": "."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "GK About Gallery",
      "blocks": [
        { "type": "image" },
        { "type": "image" },
        { "type": "image" },
        { "type": "image" }
      ]
    }
  ]
}
{% endschema %}