{% comment %}
  GK Shared Tour Dates — single source of truth
  Snippets cannot contain {% schema %}.

  Calling conventions supported:

    render 'gk-tour-dates-shared', mode: 'render_home'
      → outputs .gk-date-row markup (home section CSS)
      → all rows output; JS hides beyond initial_visible via style.display

    render 'gk-tour-dates-shared', mode: 'render_page', visible_count: <n>
      → outputs .gk-date markup
      → rows beyond visible_count get class "is-hidden" (CSS hides, JS manages)

    render 'gk-tour-dates-shared', mode: 'render', row_prefix: 'gk-date', visible_count: <n>, use_hidden_class: true
      → legacy explicit mode (same output as render_page when row_prefix='gk-date')

    render 'gk-tour-dates-shared', mode: 'count'
      → outputs only the integer count of upcoming dates

  Data source (priority order):
    1. Theme Settings → settings.gk_tour_dates_data (textarea, one date per line)
       Format per line:
         YYYY-MM-DD | Descriptor (optional) | Venue | City | State | Ticket URL (optional) | sold_out (optional)
       Example:
         2026-04-22 | support for Paul Gilbert | Barnato | Omaha | NE | https://tickets.com | false
    2. Fallback: _gk_dates_raw capture block below (used when settings textarea is blank)
       Format: Date || Venue || City, State || Ticket URL || sold_out

  Safe date filter:
    show_ts == 0 → Liquid can't parse the date string → keep it visible
    show_ts  > 0 → hide the row if show is before today midnight UTC
{% endcomment %}

{%- liquid
  assign today_ymd         = 'now' | date: '%Y-%m-%d'
  assign today_midnight_ts = today_ymd | date: '%s' | plus: 0

  assign mode          = mode | default: 'count'
  assign visible_count = visible_count | default: 10

  if mode == 'render_home'
    assign row_prefix   = 'gk-date-row'
    assign apply_hidden = false
  elsif mode == 'render_page'
    assign row_prefix   = 'gk-date'
    assign apply_hidden = true
  elsif mode == 'render'
    assign row_prefix   = row_prefix | default: 'gk-date'
    assign apply_hidden = use_hidden_class | default: false
  else
    assign row_prefix   = 'gk-date'
    assign apply_hidden = false
  endif
-%}

{%- comment -%}
  ── DATA SOURCE ───────────────────────────────────────────────────
  Priority 1 — Theme Settings textarea (settings.gk_tour_dates_data)
    Format per line: YYYY-MM-DD | Descriptor | Venue | City | State | Ticket URL | sold_out
    (Descriptor and fields after State are optional; trailing pipes may be omitted)
  Priority 2 — Hardcoded fallback capture block below
    Format per line: Date || Venue || City, State || Ticket URL || sold_out
{%- endcomment -%}
{%- capture _gk_dates_raw -%}
April 22, 2026 || Barnato || Omaha, NE || https://www.bandsintown.com/a/28503-greg-koch || false
April 24, 2026 || City Winery || St. Louis, MO || https://tickets.citywinery.com/event/paul-gilbert-mzayyg || false
April 26, 2026 || The Vixen || McHenry, IL || https://vixenmchenry.com/event/paul-gilbert/ || false
April 28, 2026 || Jergel's Rhythm Grille || Warrendale, PA || https://www.bandsintown.com/a/28503-greg-koch || false
April 29, 2026 || The Iridium || New York, NY || https://www.theiridium.com/events || false
April 30, 2026 || The Iridium || New York, NY || https://www.theiridium.com/events || false
May 1, 2026 || The Iridium || New York, NY || https://www.theiridium.com/events || false
May 2, 2026 || The Vault Music Hall || New Bedford, MA || https://www.eventbrite.com/e/paul-gilbert-greg-koch-tickets-1980232841736 || false
May 3, 2026 || Daryl's House || Pawling, NY || https://www.ticketweb.com/event/paul-gilbert-daryls-house-tickets/14064204 || false
May 5, 2026 || Ardmore Music Hall || Ardmore, PA || https://www.ardmoremusichall.com/calendar/ || false
May 7, 2026 || Tupelo Music Hall || Derry, NH || https://tickets.tupelohall.com/ordertickets.asp?p=3378 || false
May 8, 2026 || Greenwich Odeum || Greenwich, RI || https://www.greenwichodeum.com/paul-gilbert/ || false
May 12, 2026 || Rams Head On Stage || Annapolis, MD || https://www.ramsheadonstage.com/events/detail/1290778 || false
May 13, 2026 || Tally Ho Theater || Leesburg, VA || https://www.ticketmaster.com/tally-ho-theater-tickets-leesburg/venue/9383 || false
May 14, 2026 || Beacon Theatre || Hopewell, VA || https://myticketstobuy.com/event/2367 || false
May 20, 2026 || Open Chord || Knoxville, TN || https://www.openchordmusic.com/upcoming-performances || false
May 23, 2026 || Culture Room || Fort Lauderdale, FL || https://www.bandsintown.com/e/1037689667-paul-gilbert-at-culture-room || false
May 27, 2026 || House of Blues || New Orleans, LA || https://www.houseofblues.com/neworleans || false
May 28, 2026 || Warehouse Live Midtown || Houston, TX || https://warehouselivemidtown.com || false
May 30, 2026 || Granada Theater || Dallas, TX || https://www.prekindle.com/event/32661-paul-gilbert-with-special-guest-greg-koch-dallas || false
{%- endcapture -%}

{%- comment -%}
  Select active data source and whether to use the new pipe format.
{%- endcomment -%}
{%- if settings.gk_tour_dates_data != blank -%}
  {%- assign _active_data   = settings.gk_tour_dates_data -%}
  {%- assign _settings_fmt  = true -%}
{%- else -%}
  {%- assign _active_data   = _gk_dates_raw -%}
  {%- assign _settings_fmt  = false -%}
{%- endif -%}

{%- assign _date_lines    = _active_data | newline_to_br | split: '<br />' -%}
{%- assign render_index   = 0 -%}
{%- assign upcoming_count = 0 -%}

{%- for _line in _date_lines -%}
  {%- assign _trimmed = _line | strip -%}
  {%- if _trimmed != blank -%}

    {%- if _settings_fmt -%}
      {%- comment -%}── Settings format: YYYY-MM-DD | Descriptor | Venue | City | State | URL | sold_out ──{%- endcomment -%}
      {%- assign _p        = _trimmed | split: ' | ' -%}
      {%- assign raw_date  = _p[0] | default: '' | strip -%}
      {%- assign descriptor = _p[1] | default: '' | strip -%}
      {%- assign venue     = _p[2] | default: '' | strip -%}
      {%- assign _city     = _p[3] | default: '' | strip -%}
      {%- assign _state    = _p[4] | default: '' | strip -%}
      {%- if _city != blank and _state != blank -%}
        {%- assign city = _city | append: ', ' | append: _state -%}
      {%- elsif _city != blank -%}
        {%- assign city = _city -%}
      {%- else -%}
        {%- assign city = _state -%}
      {%- endif -%}
      {%- assign url       = _p[5] | default: '' | strip -%}
      {%- assign sold      = _p[6] | default: 'false' | strip -%}
      {%- assign display_date = raw_date | date: '%B %-d, %Y' -%}
      {%- if display_date == blank -%}{%- assign display_date = raw_date -%}{%- endif -%}
    {%- else -%}
      {%- comment -%}── Fallback format: Date || Venue || City, State || URL || sold_out ──{%- endcomment -%}
      {%- assign _p        = _trimmed | split: ' || ' -%}
      {%- assign raw_date  = _p[0] | default: '' | strip -%}
      {%- assign venue     = _p[1] | default: '' | strip -%}
      {%- assign city      = _p[2] | default: '' | strip -%}
      {%- assign url       = _p[3] | default: '' | strip -%}
      {%- assign sold      = _p[4] | default: 'false' | strip -%}
      {%- assign descriptor = '' -%}
      {%- assign display_date = raw_date -%}
    {%- endif -%}

    {%- liquid
      assign show_ts     = raw_date | date: '%s' | plus: 0
      assign is_upcoming = false
      if raw_date != blank
        if show_ts == 0
          assign is_upcoming = true
        elsif show_ts >= today_midnight_ts
          assign is_upcoming = true
        endif
      endif
    -%}

    {%- if is_upcoming -%}
      {%- assign upcoming_count = upcoming_count | plus: 1 -%}

      {%- if mode == 'render_home' or mode == 'render_page' or mode == 'render' -%}

        {%- assign extra_class = '' -%}
        {%- if apply_hidden and render_index >= visible_count -%}
          {%- assign extra_class = ' is-hidden' -%}
        {%- endif -%}

        <div
          class="{{ row_prefix }}{{ extra_class }}"
          role="listitem"
          data-date-row
          data-index="{{ render_index }}"
        >
          <div class="{{ row_prefix }}__date">{{ display_date }}</div>

          <div class="{{ row_prefix }}__details">
            {%- if venue != blank -%}
              <div class="{{ row_prefix }}__venue">{{ venue }}</div>
            {%- endif -%}
            {%- if descriptor != blank -%}
              <div class="{{ row_prefix }}__descriptor">{{ descriptor }}</div>
            {%- endif -%}
            {%- if city != blank -%}
              <div class="{{ row_prefix }}__city">{{ city }}</div>
            {%- endif -%}
          </div>

          <div class="{{ row_prefix }}__cta">
            {%- if sold == 'true' -%}
              {%- if row_prefix == 'gk-date' -%}
                <span class="gk-date__pill gk-date__pill--muted" aria-label="Sold out">SOLD OUT</span>
              {%- else -%}
                <span class="{{ row_prefix }}__soldout" aria-label="Sold out">SOLD OUT</span>
              {%- endif -%}
            {%- elsif url != blank -%}
              {%- if row_prefix == 'gk-date' -%}
                <a class="gk-date__pill gk-date__pill--accent" href="{{ url }}" target="_blank" rel="noopener">GET TICKETS</a>
              {%- else -%}
                <a class="{{ row_prefix }}__btn" href="{{ url }}" target="_blank" rel="noopener">GET TICKETS</a>
              {%- endif -%}
            {%- else -%}
              {%- if row_prefix == 'gk-date' -%}
                <span class="gk-date__pill gk-date__pill--muted" aria-label="Tickets unavailable">TBA</span>
              {%- else -%}
                <span class="{{ row_prefix }}__soldout" aria-label="Tickets unavailable">TBA</span>
              {%- endif -%}
            {%- endif -%}
          </div>
        </div>

        {%- assign render_index = render_index | plus: 1 -%}
      {%- endif -%}
    {%- endif -%}

  {%- endif -%}
{%- endfor -%}

{%- if mode == 'count' -%}
  {{ upcoming_count }}
{%- endif -%}
