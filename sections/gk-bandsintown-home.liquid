{% comment %}
  GK Bandsintown (Home)
  Shows first N live Bandsintown events; "Show More" reveals more each click.

  MERCHANT: Theme Editor > this section > "Events shown on load" / "Events revealed per click"
{% endcomment %}

{%- liquid
  assign bit_artist          = section.settings.artist_name
  assign bit_initial_visible = section.settings.initial_visible_count
  assign bit_reveal_step     = section.settings.reveal_step
  assign bit_more_label      = section.settings.show_more_label
  assign bit_uid             = section.id | prepend: 'gkbit-home-'
-%}

<style>
.gk-bit-home {
  box-sizing: border-box;
  width: 100%;
  background-color: {{ section.settings.bg_color }};
  padding-top: {{ section.settings.padding_top }}px;
  padding-bottom: {{ section.settings.padding_bottom }}px;
}
.gk-bit-home__inner {
  max-width: 860px;
  margin: 0 auto;
  padding: 0 20px;
  box-sizing: border-box;
}
.gk-bit-home__eyebrow {
  color: #ff6a00;
  font-size: 0.72em;
  font-weight: 700;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  margin: 0 0 8px;
}
.gk-bit-home__heading {
  color: #ffffff;
  font-size: clamp(1.6em, 4vw, 2.4em);
  font-weight: 800;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  margin: 0 0 8px;
  line-height: 1.1;
}
.gk-bit-home__subtext {
  color: rgba(255,255,255,0.5);
  font-size: 0.9em;
  margin: 0 0 28px;
}
.gk-bit-home__embed {
  width: 100%;
}

/* Hide BIT artist header, footer, RSVP */
.gk-bit-home [class*="bit-top-track"],
.gk-bit-home [class*="bit-header"],
.gk-bit-home .bit-powered-by,
.gk-bit-home .bit-footer,
.gk-bit-home .bit-social-share,
.gk-bit-home .bit-share-button,
.gk-bit-home [class*="rsvp"],
.gk-bit-home a[data-bit-action="rsvp"] {
  display: none !important;
}

/* Show-more button */
.gk-bit-home .gk-bit-more-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  color: #ff6a00;
  border: 1px solid rgba(255,106,0,0.5);
  border-radius: 999px;
  padding: 10px 28px;
  font-size: 0.78em;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
  font-family: inherit;
  transition: background 150ms ease, border-color 150ms ease;
}
.gk-bit-home .gk-bit-more-btn:hover {
  background: rgba(255,106,0,0.12);
  border-color: #ff6a00;
}

/* Fallback + editor notice */
.gk-bit-home .gk-bit-fallback {
  display: none;
  color: rgba(255,255,255,0.4);
  font-size: 0.9em;
  padding: 24px 0;
  text-align: center;
}
.gk-bit-home .gk-bit-editor-notice {
  background: rgba(255,106,0,0.08);
  border: 1px dashed rgba(255,106,0,0.35);
  border-radius: 12px;
  color: rgba(255,255,255,0.5);
  font-size: 0.85em;
  padding: 20px 24px;
  text-align: center;
}
</style>

<section class="gk-bit-home" data-section-id="{{ section.id }}">
  <div class="gk-bit-home__inner">

    {%- if section.settings.eyebrow != blank -%}
      <div class="gk-bit-home__eyebrow">{{ section.settings.eyebrow }}</div>
    {%- endif -%}
    {%- if section.settings.heading != blank -%}
      <h2 class="gk-bit-home__heading">{{ section.settings.heading }}</h2>
    {%- endif -%}
    {%- if section.settings.subtext != blank -%}
      <p class="gk-bit-home__subtext">{{ section.settings.subtext }}</p>
    {%- endif -%}

    <div id="{{ bit_uid }}" class="gk-bit-home__embed">
      {%- if request.design_mode -%}
        <div class="gk-bit-editor-notice">
          Bandsintown events load on the live site. Save and preview to see them.
        </div>
      {%- else -%}
        {%- render 'gk-bandsintown-embed', bit_artist: bit_artist -%}
        <div class="gk-bit-fallback">Check back soon for upcoming dates.</div>
      {%- endif -%}
    </div>

  </div>
</section>

<script>
(function () {
  var WRAP_ID   = {{ bit_uid | json }};
  var INIT      = {{ bit_initial_visible | plus: 0 }};
  var STEP      = {{ bit_reveal_step | plus: 0 }};
  var BTN_LABEL = {{ bit_more_label | default: 'SHOW MORE DATES' | json }};

  var wrap = document.getElementById(WRAP_ID);
  if (!wrap) return;

  var applied     = false;
  var moreBtnWrap = null;

  /* Priority-ordered selectors to find event rows */
  var SEL = [
    '.bit-event',
    '.bit-event-list-item',
    'li[class*="bit-event"]',
    '[class*="bit-event"][class*="item"]',
    '.bit-widget li',
    '.bit-widget-container li'
  ];

  function findEvents() {
    for (var i = 0; i < SEL.length; i++) {
      var els = wrap.querySelectorAll(SEL[i]);
      if (els.length) return [].slice.call(els);
    }
    return [];
  }

  function ensureMoreBtn() {
    if (moreBtnWrap) return moreBtnWrap;
    moreBtnWrap = document.createElement('div');
    moreBtnWrap.style.cssText = 'margin-top:20px;text-align:center';
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'gk-bit-more-btn';
    btn.textContent = BTN_LABEL;
    btn.addEventListener('click', function () {
      var hidden = findEvents().filter(function (el) {
        return el.getAttribute('data-gk-hidden') === '1';
      });
      hidden.slice(0, STEP).forEach(function (el) {
        el.removeAttribute('data-gk-hidden');
        el.style.removeProperty('display');
      });
      syncBtn();
    });
    moreBtnWrap.appendChild(btn);
    wrap.appendChild(moreBtnWrap);
    return moreBtnWrap;
  }

  function syncBtn() {
    if (!moreBtnWrap) return;
    var anyHidden = findEvents().some(function (el) {
      return el.getAttribute('data-gk-hidden') === '1';
    });
    moreBtnWrap.style.display = anyHidden ? '' : 'none';
  }

  function setup() {
    var events = findEvents();
    if (!events.length) return false;
    if (applied) { syncBtn(); return true; }

    applied = true;

    events.forEach(function (el, i) {
      if (i >= INIT) {
        el.setAttribute('data-gk-hidden', '1');
        el.style.setProperty('display', 'none', 'important');
      }
    });

    if (events.length > INIT) {
      ensureMoreBtn();
      syncBtn();
    }
    return true;
  }

  if (setup()) return;

  var debounce;
  var obs = new MutationObserver(function () {
    clearTimeout(debounce);
    debounce = setTimeout(function () {
      if (setup()) {
        clearInterval(retryTimer);
        obs.disconnect();
      }
    }, 200);
  });
  obs.observe(wrap, { childList: true, subtree: true });

  /* Retry every 250ms for up to 10 seconds */
  var elapsed = 0;
  var retryTimer = setInterval(function () {
    elapsed += 250;
    if (setup() || elapsed >= 10000) {
      clearInterval(retryTimer);
      obs.disconnect();
      if (!applied) {
        var fb = wrap.querySelector('.gk-bit-fallback');
        if (fb) fb.style.display = '';
      }
    }
  }, 250);
})();
</script>

{% schema %}
{
  "name": "GK Bandsintown (Home)",
  "settings": [
    {
      "type": "header",
      "content": "Header text"
    },
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow",
      "default": "Tour Dates"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "GREG KOCH DATES"
    },
    {
      "type": "text",
      "id": "subtext",
      "label": "Subtext",
      "default": "See upcoming dates below."
    },
    {
      "type": "header",
      "content": "Bandsintown"
    },
    {
      "type": "text",
      "id": "artist_name",
      "label": "Artist name",
      "info": "Must match exactly as listed on Bandsintown, e.g. Greg Koch",
      "default": "Greg Koch"
    },
    {
      "type": "header",
      "content": "Display settings"
    },
    {
      "type": "range",
      "id": "initial_visible_count",
      "label": "Events shown on load",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 3
    },
    {
      "type": "range",
      "id": "reveal_step",
      "label": "Events revealed per click",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 3
    },
    {
      "type": "text",
      "id": "show_more_label",
      "label": "Show more button label",
      "default": "SHOW MORE DATES"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#0D0D0D"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 64
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 64
    }
  ],
  "presets": [
    {
      "name": "GK Bandsintown (Home)"
    }
  ]
}
{% endschema %}
