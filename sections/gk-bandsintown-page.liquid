{% comment %}
  GK Bandsintown – Dates Page (full listing)
  Official Bandsintown widget for Greg Koch, restyled to match dark glass aesthetic.
  Shows N events initially; each "Show More" click reveals reveal_step more.

  MERCHANT: Theme Editor › this section › Bandsintown › Artist name
             Display settings › Events shown on load / Events revealed per click
{% endcomment %}

{%- liquid
  assign bit_artist          = section.settings.artist_name
  assign bit_initial_visible = section.settings.initial_visible_count
  assign bit_reveal_step     = section.settings.reveal_step
  assign bit_more_label      = section.settings.show_more_label | default: 'SHOW MORE DATES'
  assign bit_uid             = section.id | prepend: 'gkbit-page-'
-%}

<style>
/* ═══════════════════════════════════════════════════════════
   GK BANDSINTOWN PAGE — all selectors scoped to .gk-bit-page
   ═══════════════════════════════════════════════════════════ */
.gk-bit-page {
  --gkbp-bg:            {{ section.settings.bg_color }};
  --gkbp-accent:        #E8690A;
  --gkbp-accent-glow:   rgba(232,105,10,0.22);
  --gkbp-accent-strong: rgba(232,105,10,0.38);
  --gkbp-text:          #ffffff;
  --gkbp-muted:         rgba(255,255,255,0.60);
  --gkbp-ring:          rgba(255,255,255,0.10);

  box-sizing: border-box;
  width: 100%;
  background-color: var(--gkbp-bg);
  padding-top: {{ section.settings.padding_top }}px;
  padding-bottom: {{ section.settings.padding_bottom }}px;
  color: var(--gkbp-text);
}
.gk-bit-page__inner {
  max-width: {{ section.settings.max_width }}px;
  margin: 0 auto;
  padding: 0 20px;
  box-sizing: border-box;
}
.gk-bit-page__eyebrow {
  font-family: "DM Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  font-size: 12px;
  color: rgba(255,255,255,0.62);
  margin: 0 0 10px;
  display: block;
}
.gk-bit-page__heading {
  font-family: "Bebas Neue", sans-serif;
  font-weight: 400;
  letter-spacing: 0.03em;
  line-height: 1;
  font-size: clamp(44px, 6vw, 76px);
  color: var(--gkbp-text);
  margin: 0 0 8px;
  text-transform: uppercase;
}
.gk-bit-page__subtext {
  font-family: "DM Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: var(--gkbp-muted);
  font-size: 16px;
  line-height: 1.4;
  margin: 0 0 32px;
  max-width: 60ch;
}
.gk-bit-page__embed {
  width: 100%;
}

/* ── Editor notice (informational only; widget still attempts to load) ── */
.gk-bit-page .gk-bit-editor-notice {
  font-family: "DM Sans", system-ui, sans-serif;
  font-size: 12px;
  color: rgba(255,255,255,0.40);
  background: rgba(232,105,10,0.06);
  border: 1px dashed rgba(232,105,10,0.28);
  border-radius: 10px;
  padding: 10px 16px;
  margin-bottom: 14px;
  text-align: center;
}

/* ── BIT widget wrapper – strip its default chrome ── */
.gk-bit-page .bit-widget-container,
.gk-bit-page .bit-widget {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 0 !important;
}

/* ── Hide BIT elements we replace with our own headings / buttons ── */
.gk-bit-page [class*="bit-header"],
.gk-bit-page [class*="bit-top-track"],
.gk-bit-page [class*="bit-logo"],
.gk-bit-page [class*="bit-powered"],
.gk-bit-page [class*="bit-footer"],
.gk-bit-page [class*="bit-social"],
.gk-bit-page [class*="bit-share"],
.gk-bit-page [class*="bit-follow"],
.gk-bit-page [class*="rsvp"],
.gk-bit-page [class*="bit-rsvp"],
.gk-bit-page a[data-bit-action="rsvp"] {
  display: none !important;
}

/* ── Event list container ── */
.gk-bit-page .bit-event-list,
.gk-bit-page ul[class*="bit-event-list"],
.gk-bit-page [class*="bit-event-list"]:not([class*="item"]):not(li) {
  list-style: none !important;
  padding: 0 !important;
  margin: 0 !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 12px !important;
}

/* ── Individual event rows – dark glass card ── */
.gk-bit-page .bit-event,
.gk-bit-page .bit-event-list-item,
.gk-bit-page li[class*="bit-event"],
.gk-bit-page [class*="bit-event"][class*="item"] {
  position: relative !important;
  list-style: none !important;
  border-radius: 18px !important;
  border: 1px solid var(--gkbp-ring) !important;
  background:
    radial-gradient(1200px 200px at 20% 0%, rgba(255,255,255,0.06), transparent 50%),
    linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)) !important;
  box-shadow: 0 18px 42px rgba(0,0,0,0.32) !important;
  transition: transform 160ms ease, border-color 160ms ease, box-shadow 160ms ease !important;
  padding: 18px 22px !important;
  margin: 0 !important;
  overflow: visible !important;
}

/* Hover glow overlay */
.gk-bit-page .bit-event::before,
.gk-bit-page .bit-event-list-item::before,
.gk-bit-page li[class*="bit-event"]::before {
  content: "" !important;
  position: absolute !important;
  inset: 0 !important;
  border-radius: 18px !important;
  pointer-events: none !important;
  opacity: 0 !important;
  transition: opacity 160ms ease !important;
  background:
    radial-gradient(800px 160px at 20% 50%, var(--gkbp-accent-strong), transparent 65%),
    linear-gradient(90deg, rgba(232,105,10,0.10), rgba(232,105,10,0.00) 55%) !important;
  z-index: 0 !important;
}

.gk-bit-page .bit-event:hover,
.gk-bit-page .bit-event-list-item:hover,
.gk-bit-page li[class*="bit-event"]:hover {
  transform: translateY(-1px) !important;
  border-color: rgba(232,105,10,0.45) !important;
  box-shadow:
    0 22px 58px rgba(0,0,0,0.40),
    0 0 0 1px rgba(232,105,10,0.18) inset !important;
}

.gk-bit-page .bit-event:hover::before,
.gk-bit-page .bit-event-list-item:hover::before,
.gk-bit-page li[class*="bit-event"]:hover::before {
  opacity: 1 !important;
}

/* ── Date text ── */
.gk-bit-page [class*="bit-event"] [class*="bit-date"],
.gk-bit-page [class*="bit-event"] .bit-event-date,
.gk-bit-page [class*="bit-event"] time {
  font-family: "Bebas Neue", sans-serif !important;
  font-size: 34px !important;
  line-height: 1 !important;
  color: var(--gkbp-accent) !important;
  letter-spacing: 0.02em !important;
  white-space: nowrap !important;
}

/* ── Venue / show name ── */
.gk-bit-page [class*="bit-event"] [class*="bit-venue"],
.gk-bit-page [class*="bit-event"] [class*="bit-title"],
.gk-bit-page [class*="bit-event"] [class*="bit-name"]:not([class*="artist"]) {
  font-family: "DM Sans", system-ui, -apple-system, sans-serif !important;
  font-size: 20px !important;
  color: var(--gkbp-text) !important;
  font-weight: 500 !important;
  line-height: 1.2 !important;
}

/* ── Location / city ── */
.gk-bit-page [class*="bit-event"] [class*="bit-location"],
.gk-bit-page [class*="bit-event"] [class*="bit-city"],
.gk-bit-page [class*="bit-event"] [class*="bit-region"],
.gk-bit-page [class*="bit-event"] [class*="bit-country"] {
  font-family: "DM Mono", ui-monospace, monospace !important;
  font-size: 13px !important;
  letter-spacing: 0.10em !important;
  text-transform: uppercase !important;
  color: rgba(255,255,255,0.65) !important;
}

/* ── Ticket / CTA button – orange pill ── */
.gk-bit-page [class*="bit-event"] a[class*="bit-btn"]:not([class*="rsvp"]),
.gk-bit-page [class*="bit-event"] a[data-bit-action="tickets"],
.gk-bit-page [class*="bit-event"] a[class*="bit-ticket"],
.gk-bit-page [class*="bit-event"] [class*="bit-cta"] a:not([class*="rsvp"]) {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  min-height: 44px !important;
  padding: 10px 20px !important;
  border-radius: 999px !important;
  background: rgba(232,105,10,0.90) !important;
  border: 1px solid rgba(232,105,10,0.90) !important;
  color: #0D0D0D !important;
  font-family: "DM Mono", ui-monospace, monospace !important;
  font-size: 12px !important;
  font-weight: 700 !important;
  letter-spacing: 0.12em !important;
  text-transform: uppercase !important;
  text-decoration: none !important;
  white-space: nowrap !important;
  transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease !important;
}
.gk-bit-page [class*="bit-event"] a[class*="bit-btn"]:not([class*="rsvp"]):hover,
.gk-bit-page [class*="bit-event"] a[data-bit-action="tickets"]:hover {
  transform: translateY(-1px) !important;
  background: rgba(232,105,10,1) !important;
  box-shadow: 0 10px 26px rgba(232,105,10,0.30) !important;
}

/* ── "No upcoming dates" message from BIT ── */
.gk-bit-page [class*="bit-no-dates"],
.gk-bit-page [class*="bit-empty-state"] {
  font-family: "DM Sans", system-ui, sans-serif !important;
  color: var(--gkbp-muted) !important;
  text-align: center !important;
  padding: 32px 0 !important;
  font-size: 16px !important;
  background: transparent !important;
}

/* ── Show-more button ── */
.gk-bit-page .gk-bit-more-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-height: 44px;
  padding: 10px 28px;
  border-radius: 999px;
  background: transparent;
  color: var(--gkbp-accent);
  border: 1px solid rgba(232,105,10,0.45);
  font-family: "DM Mono", ui-monospace, monospace;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  cursor: pointer;
  transition: background 150ms ease, border-color 150ms ease, transform 140ms ease, box-shadow 140ms ease;
}
.gk-bit-page .gk-bit-more-btn:hover {
  background: rgba(232,105,10,0.10);
  border-color: #E8690A;
  transform: translateY(-1px);
  box-shadow: 0 8px 20px rgba(232,105,10,0.14);
}
.gk-bit-page .gk-bit-more-btn:active {
  transform: translateY(0);
}
.gk-bit-page .gk-bit-more-btn:focus-visible {
  outline: 2px solid rgba(232,105,10,0.75);
  outline-offset: 3px;
}

/* ── Fallback message (shown only if BIT fails to load after timeout) ── */
.gk-bit-page .gk-bit-fallback {
  display: none;
  font-family: "DM Sans", system-ui, sans-serif;
  color: var(--gkbp-muted);
  font-size: 16px;
  padding: 32px 0;
  text-align: center;
}

/* ── Responsive ── */
@media (max-width: 820px) {
  .gk-bit-page .bit-event,
  .gk-bit-page .bit-event-list-item,
  .gk-bit-page li[class*="bit-event"] {
    padding: 16px 16px !important;
  }
  .gk-bit-page [class*="bit-event"] [class*="bit-date"] {
    font-size: 26px !important;
  }
  .gk-bit-page [class*="bit-event"] [class*="bit-venue"] {
    font-size: 17px !important;
  }
}
@media (max-width: 500px) {
  .gk-bit-page [class*="bit-event"] [class*="bit-date"] {
    font-size: 22px !important;
  }
  .gk-bit-page [class*="bit-event"] [class*="bit-venue"] {
    font-size: 15px !important;
  }
}
</style>

<section class="gk-bit-page" data-section-id="{{ section.id }}">
  <div class="gk-bit-page__inner">

    {%- if section.settings.eyebrow != blank -%}
      <div class="gk-bit-page__eyebrow">{{ section.settings.eyebrow }}</div>
    {%- endif -%}
    {%- if section.settings.heading != blank -%}
      <h1 class="gk-bit-page__heading">{{ section.settings.heading }}</h1>
    {%- endif -%}
    {%- if section.settings.subtext != blank -%}
      <p class="gk-bit-page__subtext">{{ section.settings.subtext }}</p>
    {%- endif -%}

    {%- if request.design_mode -%}
      <div class="gk-bit-editor-notice">
        &#9432;&nbsp; Theme Editor: Bandsintown events load live. Click "View" or open the published site to see them.
      </div>
    {%- endif -%}

    <div id="{{ bit_uid }}" class="gk-bit-page__embed" data-bit-wrap>
      {%- comment -%}
        Official Bandsintown anchor-initializer. BIT script below finds this element
        and replaces it with the rendered widget (event list + ticket links).
      {%- endcomment -%}
      <a class="bit-widget-initializer"
         data-artist-name="{{ bit_artist | escape }}"
         data-display-local-dates="false"
         data-display-past-dates="false"
         data-auto-style="false"
         data-button-label-upcoming-events=""
         data-button-label-expired-token="Refresh"
         data-lang="en"
         data-popup-background-color="#111111"
         data-text-color="#ffffff"
         data-link-color="#E8690A"
         data-background-color="rgba(0,0,0,0)"
         data-separator-color="rgba(255,255,255,0.08)"
         data-display-limit="60"
      ></a>
      <div class="gk-bit-fallback">Check back soon for upcoming dates.</div>
    </div>

  </div>
</section>

{%- comment -%}
  Load / re-trigger Bandsintown widget script.
  On initial page load BIT isn't loaded yet, so we inject it.
  On Shopify theme-editor re-render (save / setting change) the section HTML
  is replaced but window globals survive — so we must remove the old <script>
  and inject a fresh one to force main.min.js to re-execute and process the
  new .bit-widget-initializer anchor that just appeared in the DOM.
{%- endcomment -%}
<script>
(function(){
  var ATTR = 'data-gk-bit';
  var prev = document.querySelector('script[' + ATTR + ']');
  if (prev) prev.parentNode.removeChild(prev);
  var s = document.createElement('script');
  s.charset = 'utf-8';
  s.src = 'https://widget.bandsintown.com/main.min.js';
  s.setAttribute(ATTR, '');
  document.head.appendChild(s);
})();
</script>

<script>
(function () {
  'use strict';

  var SECTION_ID = {{ section.id | json }};
  var WRAP_ID    = {{ bit_uid | json }};
  var INIT       = {{ bit_initial_visible | plus: 0 }};
  var STEP       = {{ bit_reveal_step | plus: 0 }};
  var BTN_LABEL  = {{ bit_more_label | json }};

  /* ── Reusable init function (called on first load + editor re-renders) ── */
  function bootShowMore() {
    var wrap = document.getElementById(WRAP_ID);
    if (!wrap) return;

    /* Prevent double-init within the same render cycle */
    if (wrap.getAttribute('data-bit-initialized') === '1') return;
    wrap.setAttribute('data-bit-initialized', '1');

    var applied     = false;
    var moreBtnWrap = null;

    /* Priority-ordered selectors – tries each until it finds event nodes */
    var EVENT_SELS = [
      '.bit-event',
      '.bit-event-list-item',
      'li[class*="bit-event"]',
      '[class*="bit-event"][class*="item"]',
      '.bit-widget li',
      '.bit-widget-container li'
    ];

    function findEvents() {
      for (var i = 0; i < EVENT_SELS.length; i++) {
        var els = wrap.querySelectorAll(EVENT_SELS[i]);
        if (els.length) return Array.prototype.slice.call(els);
      }
      return [];
    }

    function ensureMoreBtn() {
      if (moreBtnWrap) return moreBtnWrap;

      moreBtnWrap = document.createElement('div');
      moreBtnWrap.style.cssText = 'margin-top:24px;text-align:center;';

      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'gk-bit-more-btn';
      btn.textContent = BTN_LABEL;
      btn.addEventListener('click', function () {
        var hidden = findEvents().filter(function (el) {
          return el.getAttribute('data-gk-hidden') === '1';
        });
        hidden.slice(0, STEP).forEach(function (el) {
          el.removeAttribute('data-gk-hidden');
          el.style.removeProperty('display');
        });
        syncBtn();
      });

      moreBtnWrap.appendChild(btn);

      /* Append after the BIT container, or fall back to inside wrap */
      var bitContainer = wrap.querySelector('.bit-widget-container') ||
                         wrap.querySelector('.bit-widget');
      if (bitContainer && bitContainer.parentNode === wrap) {
        wrap.insertBefore(moreBtnWrap, bitContainer.nextSibling);
      } else {
        wrap.appendChild(moreBtnWrap);
      }

      return moreBtnWrap;
    }

    function syncBtn() {
      if (!moreBtnWrap) return;
      var anyHidden = findEvents().some(function (el) {
        return el.getAttribute('data-gk-hidden') === '1';
      });
      moreBtnWrap.style.display = anyHidden ? '' : 'none';
    }

    function setup() {
      var events = findEvents();
      if (!events.length) return false;
      if (applied) { syncBtn(); return true; }

      applied = true;

      /* Hide events beyond the initial visible count */
      events.forEach(function (el, i) {
        if (i >= INIT) {
          el.setAttribute('data-gk-hidden', '1');
          el.style.setProperty('display', 'none', 'important');
        }
      });

      if (events.length > INIT) {
        ensureMoreBtn();
        syncBtn();
      }

      /* BIT succeeded – suppress the fallback text */
      var fb = wrap.querySelector('.gk-bit-fallback');
      if (fb) fb.style.display = 'none';

      return true;
    }

    /* Try immediately (BIT may have already rendered) */
    if (setup()) return;

    /* Watch for BIT's async DOM injection */
    var debounceTimer;
    var obs = new MutationObserver(function () {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function () {
        if (setup()) {
          obs.disconnect();
          clearInterval(retryTimer);
        }
      }, 180);
    });
    obs.observe(wrap, { childList: true, subtree: true });

    /* Belt-and-suspenders: poll every 300 ms for up to 15 s */
    var elapsed = 0;
    var retryTimer = setInterval(function () {
      elapsed += 300;
      if (setup()) {
        obs.disconnect();
        clearInterval(retryTimer);
      } else if (elapsed >= 15000) {
        obs.disconnect();
        clearInterval(retryTimer);
        if (!applied) {
          var fb = wrap.querySelector('.gk-bit-fallback');
          if (fb) fb.style.display = '';
        }
      }
    }, 300);
  }

  /* ── Run on initial page load ── */
  bootShowMore();

  /* ── Shopify theme editor: re-init on section reload after save ── */
  var listenerKey = '__gkBitEvt_' + SECTION_ID;
  if (window.Shopify && window.Shopify.designMode && !window[listenerKey]) {
    window[listenerKey] = true;
    document.addEventListener('shopify:section:load', function (evt) {
      if (!evt.detail || evt.detail.sectionId !== SECTION_ID) return;

      /* Re-trigger BIT for the freshly-rendered anchor */
      var ATTR = 'data-gk-bit';
      var prev = document.querySelector('script[' + ATTR + ']');
      if (prev) prev.parentNode.removeChild(prev);
      var s = document.createElement('script');
      s.charset = 'utf-8';
      s.src = 'https://widget.bandsintown.com/main.min.js';
      s.setAttribute(ATTR, '');
      document.head.appendChild(s);

      /* Re-run show-more init (BIT needs a moment to render) */
      setTimeout(bootShowMore, 600);
    });
  }

}());
</script>

{% schema %}
{
  "name": "GK Bandsintown (Page)",
  "settings": [
    {
      "type": "header",
      "content": "Header text"
    },
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow",
      "default": "Tour Dates"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "TOUR DATES"
    },
    {
      "type": "text",
      "id": "subtext",
      "label": "Subtext",
      "default": "All upcoming live dates below. Tickets available at each show."
    },
    {
      "type": "header",
      "content": "Bandsintown"
    },
    {
      "type": "text",
      "id": "artist_name",
      "label": "Artist name",
      "info": "Must match your Bandsintown artist page exactly, e.g. Greg Koch",
      "default": "Greg Koch"
    },
    {
      "type": "header",
      "content": "Display settings"
    },
    {
      "type": "range",
      "id": "initial_visible_count",
      "label": "Events shown on load",
      "min": 1,
      "max": 30,
      "step": 1,
      "default": 10
    },
    {
      "type": "range",
      "id": "reveal_step",
      "label": "Events revealed per click",
      "min": 1,
      "max": 30,
      "step": 1,
      "default": 5
    },
    {
      "type": "text",
      "id": "show_more_label",
      "label": "Show more button label",
      "default": "SHOW MORE DATES"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#0D0D0D"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Max content width (px)",
      "min": 600,
      "max": 1400,
      "step": 20,
      "default": 1100
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 64
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 64
    }
  ],
  "presets": [
    {
      "name": "GK Bandsintown (Page)"
    }
  ]
}
{% endschema %}
